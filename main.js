"use strict";function t(t,e,o){if(o||2===arguments.length)for(var i,n=0,r=e.length;n<r;n++)!i&&n in e||(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))}var e=function(e,i,n){var r;"xclip"!==n&&"wl-copy"!==n&&(mp.msg.error("ERROR: ".concat(n," is not a known copy utility. ")+"Possible values are: xclip, wl-copy"),print("INFO: setting copy utility to 'xclip'"),n="xclip"),"primary"!=i&&"clipboard"!=i&&(print("ERROR: ".concat(i," is not a valid selection. ")+"Possible values are: primary, clipboard"),print("INFO: setting selection to 'primary'"),i="primary"),"xclip"===n?r=["xclip","-selection",i]:(r=["wl-copy"],"primary"===i&&(r=t(t([],r,!0),["--primary"],!1)));var s=mp.command_native({name:"subprocess",args:r,stdin_data:e,detach:!0}).status;if(-3===s)return mp.msg.error("Received status: ".concat(s)),void o("Error occurred during the execution of ".concat(n,". ")+"Please verify your ".concat(n," installation."));o("Copied to ".concat(i,": ").concat(e))},o=function(t){mp.osd_message(t),print(t)},i=function(t){if(-1!==t.search("youtube|youtu.be"))return"youtube"},n=function(){function e(){this.burnSubs=!1}return e.prototype.preview=function(t,e,i){o("Processing preview");var n=mp.get_property("path"),s="yes"===mp.get_property("mute")?"-an":"",p="".concat(s," -map_metadata -1 -map_chapters -1 -f matroska ")+"-c:v libx264 -preset ultrafast - | mpv - --loop",c=r(n,t,e,i,!1,!0),a=c.inputs,u=c.cropLavfi,h=a.map((function(t,e){return"-map ".concat(e,":v? -map ").concat(e,":a?")})),m="ffmpeg -hide_banner ".concat(a.join(" ")," ").concat(h.join(" ")," ").concat(u," ").concat(p);mp.commandv("run","bash","-c","(".concat(m,")"))},e.prototype.encode=function(e,o,i,n){var s=mp.get_property("path"),p=r(s,e,o,i,!0,!0),c=p.inputs,a=p.cropLavfi,u=t(["purewebm"],c,!0);a&&u.push.apply(u,a.split(" ")),this.burnSubs&&u.push("-subs"),n&&u.push.apply(u,["--extra_params",n]),mp.command_native({name:"subprocess",args:u,detach:!0})},e}(),r=function(t,e,o,i,n,r){var a=s(e,o);return{inputs:p(t,a,n,r),cropLavfi:i?c(i):null}},s=function(t,e){return t&&e?"-ss ".concat(t," -to ").concat(e):t?"-ss ".concat(t):e?"-to ".concat(e):""},p=function(e,o,n,r){var s=-1!==e.search("^http[s]?://");if(!o&&!s)return n?["-i","".concat(e)]:['-i "'.concat(e,'"')];if(!s)return n?t(t([],o.split(" "),!0),["-i","".concat(e)],!1):r?["".concat(o,' -i "').concat(e,'"')]:['-i "'.concat(e,'" ').concat(o)];var p=function(t){if("youtube"===i(t)){for(var e=[],o=0,n=mp.get_property("stream-open-filename").split(";");o<n.length;o++){var r=n[o];if(-1!==r.search("googlevideo")){var s=r.match(/http.*/);null!==s&&e.push(s[0])}}return e}}(e),c=[];if(!p)throw new Error("ERROR: Unable to parse the stream urls. Source is unknown");for(var a=0,u=p;a<u.length;a++){var h=u[a];n?c.push.apply(c,t(t([],o.split(" "),!1),["-i","".concat(h)],!1)):r?c.push("".concat(o,' -i "').concat(h,'"')):c.push('-i "'.concat(h,'" ').concat(o))}return c},c=function(t){return""!==t.toString()?"-lavfi crop=".concat(t.toString()):""},a=function(){function t(){this.width=null,this.height=null}return t.prototype.getProperties=function(){this.width=mp.get_property_native("width"),this.height=mp.get_property_native("height")},t}(),u=function(){function t(){this.x=null,this.y=null}return t.prototype.getProperties=function(){var t;t=mp.get_property_native("mouse-pos"),this.x=t.x,this.y=t.y},t}(),h=function(){function t(){this.video=new a,this.mouse=new u,this.pid=mp.utils.getpid()}return t.prototype.getCrop=function(){this.video.getProperties(),this.mouse.getProperties();var t=mp.command_native({name:"subprocess",args:["purebox",this.pid.toString(),this.mouse.x.toString(),this.mouse.y.toString(),this.video.width.toString(),this.video.height.toString()],capture_stdout:!0});if(0!==t.status)throw new Error("An error occurred during the execution of PureBox");return t.stdout.split(", ").map((function(t){return Number(t)}))},t}(),m=function(){function t(t,e){this.isCropping=!1,this.hideOSC=e,t?this.pureBox=new h:(this.mouse=new u,this.video=new a)}return t.prototype.getCrop=function(t){var e;t&&!this.isCropping&&b(d)?this.resetCrop():this.pureBox?(e=this.pureBox.getCrop(),d.x=e[0],d.y=e[1],d.w=e[2],d.h=e[3]):this.generateCrop()},t.prototype.generateCrop=function(){this.isCropping?(l.remove(),this.normalizeCrop(),this.isCropping=!1,mp.unobserve_property(y),this.hideOSC&&mp.command("script-message osc-visibility auto"),print("Cropping ended")):(this.isCropping=!0,this.setInitialMousePosition(),mp.observe_property("mouse-pos","native",y),this.hideOSC&&mp.command("script-message osc-visibility never"),print("Cropping started"))},t.prototype.setInitialMousePosition=function(){this.mouse.getProperties(),d.x=this.mouse.x,d.y=this.mouse.y,d.constX=this.mouse.x,d.constY=this.mouse.y},t.prototype.normalizeCrop=function(){var t=mp.get_osd_size();if(this.video.getProperties(),"number"!=typeof this.video.height||"number"!=typeof this.video.width)throw new Error("Unable to get the video's properties");if(!_(t))throw new Error("Unable to get the OSD sizes");if(!b(d))throw new Error("cropBox is not set");var e=t.width,o=t.height,i=[0,0],n=i[0],r=i[1],s=o*this.video.width/this.video.height,p=e*this.video.height/this.video.width;s>e?(s=e,n=o-p):p>o&&(p=o,r=e-s),d.y-=Math.ceil(n/2),d.x-=Math.ceil(r/2);var c=Math.min(this.video.width/s,this.video.height/p);d.w=Math.ceil(d.w*c),d.h=Math.ceil(d.h*c),d.x=Math.ceil(d.x*c),d.y=Math.ceil(d.y*c)},t.prototype.toString=function(){return b(d)?"".concat(d.w,":").concat(d.h,":").concat(d.x,":").concat(d.y):""},t.prototype.resetCrop=function(){d.constX=null,d.constY=null,d.w=null,d.h=null,d.x=null,d.y=null,o("Crop reset")},t}(),d={w:null,h:null,x:null,y:null,constX:null,constY:null},l=mp.create_osd_overlay("ass-events"),y=function(t,e){if(!v(e))throw new Error("Not a MousePos: ".concat(JSON.stringify(e)));f(e),g()},g=function(){if(!b(d))throw new Error("cropbox is not set");var t="{\\3c&".concat("9314FF","&}"),e=mp.get_osd_size();_(e)?(l.res_x=e.width,l.res_y=e.height):mp.msg.error("ERROR: Couldn't get the OSD size.The drawn cropbox might be incorrect.");var o=d.x,i=d.y,n=d.w,r=d.h,s="{\\p1}m ".concat(o," ").concat(i," l ").concat(o+n," ").concat(i," ").concat(o+n," ")+"".concat(i+r," ").concat(o," ").concat(i+r," {\\p0}"),p="".concat("{\\pos(0, 0)}").concat(t).concat("{\\1a&FF&}").concat("{\\bord4}").concat(s);l.data=p,l.update()},f=function(t){if("number"!=typeof d.constX||"number"!=typeof d.constY||"number"!=typeof d.x||"number"!=typeof d.y)throw new Error("the cropbox was not initialized: ".concat(JSON.stringify(d)));var e=t.x,o=t.y;e<d.constX?(d.x=e,e=d.constX,d.x=Math.min(e,d.x),d.w=e-d.x):(e=Math.max(e,d.x),d.x=Math.min(e,d.x),d.w=e-d.x),o<d.constY?(d.y=o,o=d.constY,d.y=Math.min(o,d.y),d.h=o-d.y):(o=Math.max(o,d.y),d.y=Math.min(o,d.y),d.h=o-d.y)},v=function(t){return"number"==typeof(null==t?void 0:t.x)&&"number"==typeof(null==t?void 0:t.y)},_=function(t){return void 0!==t&&"number"==typeof(null==t?void 0:t.width)&&"number"==typeof(null==t?void 0:t.height)},b=function(t){return"number"==typeof t.w&&"number"==typeof t.h&&"number"==typeof t.x&&"number"==typeof t.constX&&"number"==typeof t.constY};new(function(){function i(){this.setKeybindings(),this.options=this.loadConfig(),this.endTime=null,this.startTime=null,this.encoder=new n,this.cropBox=new m(this.options.pure_box,this.options.hide_osc_on_crop)}return i.prototype.setKeybindings=function(){var t=this;mp.add_key_binding("ctrl+w","get-file-path",(function(){return t.getFilePath()})),mp.add_key_binding("ctrl+shift+w","generate-preview",(function(){return t.encode("preview")})),mp.add_key_binding("ctrl+e","get-timestamp",(function(){return t.getTimestamp()})),mp.add_key_binding("ctrl+shift+e","set-endtime",(function(){return t.getTimestamp({getEndTime:!0})})),mp.add_key_binding("ctrl+c","get-crop",(function(){return t.crop()})),mp.add_key_binding("ctrl+p","toggle-puremode",(function(){return t.togglePureMode()}))},i.prototype.loadConfig=function(){var t=this,e={copy_mode:"ffmpeg",pure_mode:!0,pure_box:!1,pure_webm:!1,ffmpeg_params:"",purewebm_extra_params:"",input_seeking:!0,selection:"primary",copy_utility:"detect",hide_osc_on_crop:!1};if(mp.options.read_options(e,"PureMPV"),e.pure_mode||(mp.remove_key_binding("generate-preview"),mp.remove_key_binding("set-endtime")),e.pure_webm&&(mp.add_key_binding("ctrl+o","purewebm",(function(){return t.encode("purewebm")})),mp.add_key_binding("ctrl+shift+o","purewebm-extra-params",(function(){return t.encode("purewebm-extra-params")})),mp.add_key_binding("ctrl+v","toggle-burn-subs",(function(){t.encoder.burnSubs=!t.encoder.burnSubs,o("Burn subtitles: ".concat(t.encoder.burnSubs?"yes":"no"))}))),"detect"===e.copy_utility)try{e.copy_utility=function(){if(-3!==mp.command_native({name:"subprocess",args:["xclip","-version"],detach:!0,capture_stderr:!0}).status)return"xclip";if(-3!==mp.command_native({name:"subprocess",args:["wl-copy","--version"],detach:!0,capture_stdout:!0}).status)return"wl-copy";throw new Error("No xclip/wl-clipboard found installed. Copying will not work.")}()}catch(t){t instanceof Error&&(mp.msg.error(t.message),e.copy_utility="xclip")}return e},i.prototype.crop=function(){this.cropBox.getCrop(this.options.pure_mode),this.options.pure_mode||this.cropBox.isCropping||e(this.cropBox.toString(),this.options.selection,this.options.copy_utility)},i.prototype.encode=function(e){var o,i,n,r=[this.startTime,this.endTime,this.cropBox];switch(e){case"preview":return void(o=this.encoder).preview.apply(o,r);case"purewebm":return void(i=this.encoder).encode.apply(i,r);case"purewebm-extra-params":return void(n=this.encoder).encode.apply(n,t(t([],r,!1),[this.options.purewebm_extra_params],!1))}},i.prototype.getFilePath=function(){var t=mp.get_property("path");if(this.options.pure_mode){var o=function(t,e,o,i){void 0===o&&(o=""),void 0===i&&(i=""),"purewebm"===o?i="":o="ffmpeg";var n=c(e);return"".concat(o," ").concat(t.join(" ")," ").concat(n," ").concat(i).trim()}(r(t,this.startTime,this.endTime,null,!1,this.options.input_seeking).inputs,this.cropBox,this.options.copy_mode,this.options.ffmpeg_params);e(o,this.options.selection,this.options.copy_utility)}else e(t,this.options.selection,this.options.copy_utility)},i.prototype.getTimestamp=function(t){var i,n,r=(n=mp.get_property_native("time-pos"),new Date(1e3*n).toISOString().substring(11,23));if((null==t?void 0:t.getEndTime)&&this.options.pure_mode)return this.endTime=r,void o("Set end time: ".concat(this.endTime));this.options.pure_mode?this.startTime?this.endTime?(i=[null,null],this.startTime=i[0],this.endTime=i[1],o("Times reset")):(this.endTime=r,o("Set end time: ".concat(this.endTime))):(this.startTime=r,o("Set start time: ".concat(this.startTime))):e(r,this.options.selection,this.options.copy_utility)},i.prototype.togglePureMode=function(){var t=this;this.options.pure_mode=!this.options.pure_mode;var e="Pure Mode: ";this.options.pure_mode?(e+="ON",mp.add_key_binding("ctrl+shift+w","generate-preview",(function(){return t.encode("preview")})),mp.add_key_binding("ctrl+shift+e","set-endtime",(function(){return t.getTimestamp({getEndTime:!0})}))):(e+="OFF",mp.remove_key_binding("generate-preview"),mp.remove_key_binding("set-endtime")),o(e)},i}());
